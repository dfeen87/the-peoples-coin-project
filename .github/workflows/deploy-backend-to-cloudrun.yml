name: Deploy Backend to Cloud Run

on:
  push:
    branches:
      - main # Or your backend's deployment branch

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write' # REQUIRED for Workload Identity Federation

    steps:
      # Checkout your backend code
      - name: Checkout code
        uses: actions/checkout@v4

      # Authenticate to Google Cloud using Workload Identity Federation
      # This step provides credentials for subsequent GCP actions (Artifact Registry, Cloud Run)
      - name: Authenticate to Google Cloud
        id: auth_gcp
        uses: 'google-github-actions/auth@v2'
        with:
          # REPLACE 'YOUR_PROJECT_NUMBER' with your actual Google Cloud Project Number
          # (Find it in GCP Console -> Project settings -> Project info -> Project number)
          workload_identity_provider: 'projects/YOUR_PROJECT_NUMBER/locations/global/pools/default/providers/github'
          # REPLACE 'your-github-actions-sa@your-project-id.iam.gserviceaccount.com'
          # with the email of the Service Account you created for GitHub Actions
          # This SA needs 'Artifact Registry Writer' and 'Cloud Run Developer' roles.
          service_account: 'github-actions-sa@heroic-tide-428421-q7.iam.gserviceaccount.com'

      # Set up Docker Buildx (for building multi-platform images if needed, good practice)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Login to Artifact Registry
      # This uses the credentials from the 'auth_gcp' step
      - name: Login to Artifact Registry
        uses: docker/login-action@v3
        with:
          registry: us-central1-docker.pkg.dev # Your Artifact Registry location
          # No username/password needed here if 'google-github-actions/auth' is used for WIF

      # Build and Push Backend Docker Image
      # 'backend-images' is the new repository name you created
      - name: Build and Push Backend Docker Image
        env:
          IMAGE_NAME: us-central1-docker.pkg.dev/heroic-tide-428421-q7/backend-images/backend-api:${{ github.sha }}
        run: |
          docker build . --tag $IMAGE_NAME
          docker push $IMAGE_NAME

      # Deploy to Cloud Run
      # This also uses the credentials from the 'auth_gcp' step
      - name: Deploy to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2.7.3
        with:
          service: 'peoples-coin-backend' # The name of your Cloud Run service
          image: us-central1-docker.pkg.dev/heroic-tide-428421-q7/backend-images/backend-api:${{ github.sha }}
          region: 'us-central1' # Your Cloud Run region
          allow-unauthenticated: true # Or adjust authentication as needed
          # Add other Cloud Run specific configurations if necessary
