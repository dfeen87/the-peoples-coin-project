name: Deploy Backend to Cloud Run

on:
  push:
    branches:
      - main # Or your backend's deployment branch

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write' # Required for Workload Identity Federation

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Build and Push Docker Image
      # Assuming your backend has a Dockerfile in its root
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Artifact Registry
        uses: docker/login-action@v3
        with:
          registry: us-central1-docker.pkg.dev # Use your Artifact Registry location (e.g., us-central1-docker.pkg.dev)
          # You'll likely use Workload Identity Federation here, or a service account key as a secret
          # For Workload Identity Federation, ensure you've configured:
          # - your GitHub repo as a Workload Identity Provider
          # - a GCP Service Account with Artifact Registry Writer role
          # - a step before this for 'google-github-actions/auth'
          username: _json_key
          password: ${{ secrets.GCP_ARTIFACT_REGISTRY_KEY }} # Example using a secret. REPLACE with your actual secret name.

      - name: Build and Push Backend Docker Image
        env:
          IMAGE_NAME: us-central1-docker.pkg.dev/heroic-tide-428421-q7/your-backend-repo/backend-api:${{ github.sha }} # Adjust your project ID and repo name
        run: |
          docker build . --tag $IMAGE_NAME
          docker push $IMAGE_NAME

      # Authenticate for Cloud Run Deployment
      - name: Authenticate Google Cloud for Deployment
        id: auth_deploy
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: 'projects/YOUR_PROJECT_NUMBER/locations/global/pools/default/providers/github' # REPLACE with your WIF provider
          service_account: 'cloud-run-deployer@heroic-tide-428421-q7.iam.gserviceaccount.com' # REPLACE with your Cloud Run deployer SA

      # Deploy to Cloud Run (USING THE SNIPPET YOU PROVIDED)
      - name: Deploy to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2.7.3 # Your provided snippet
        with:
          service: 'peoples-coin-backend' # The name of your Cloud Run service
          image: us-central1-docker.pkg.dev/heroic-tide-428421-q7/your-backend-repo/backend-api:${{ github.sha }} # Use the image pushed above
          region: 'us-central1' # Your Cloud Run region
          allow-unauthenticated: true # Or adjust authentication as needed
          # Add other Cloud Run specific configurations if necessary
